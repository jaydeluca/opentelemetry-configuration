name: Sync Documentation (Reusable)

on:
  workflow_call:
    inputs:
      page_param:
        description: 'PAGE parameter for make command'
        required: false
        type: string
        default: ''
      branch_prefix:
        description: 'Prefix used for the name of the branch created for the PR'
        required: true
        type: string
      commit_title:
        description: 'Commit message title'
        required: true
        type: string
      pr_title:
        description: 'Pull request title'
        required: true
        type: string
      pr_body_header:
        description: 'Pull request body header'
        required: true
        type: string
      pr_body_changes:
        description: 'Pull request body changes description'
        required: true
        type: string
      target_repo_owner:
        description: 'Repository owner to create PR against'
        required: false
        type: string
        default: 'open-telemetry'
      target_branch:
        description: 'Target branch in opentelemetry.io repository'
        required: false
        type: string
        default: 'main'
    secrets:
      # GitHub App credentials (for official OpenTelemetry bot)
      OTELBOT_GITHUB_APP_ID:
        required: false
      OTELBOT_GITHUB_APP_PRIVATE_KEY:
        required: false
      # PAT token (for fork-based testing)
      PAT_TOKEN:
        required: false
      DOCS_REPO_OWNER:
        required: false

permissions:
  contents: read
  pull-requests: write

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: generate-token
        continue-on-error: true
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.OTELBOT_GITHUB_APP_ID }}
          private-key: ${{ secrets.OTELBOT_GITHUB_APP_PRIVATE_KEY }}
          owner: ${{ inputs.target_repo_owner }}

      - name: Select authentication token
        id: auth
        run: |
          # Use GitHub App token if available, otherwise use PAT (fork testing mode)
          if [ -n "${{ steps.generate-token.outputs.token }}" ]; then
            echo "token=${{ steps.generate-token.outputs.token }}" >> $GITHUB_OUTPUT
            echo "mode=upstream" >> $GITHUB_OUTPUT
            echo "Using upstream bot authentication"
          elif [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "token=${{ secrets.PAT_TOKEN }}" >> $GITHUB_OUTPUT
            echo "mode=fork" >> $GITHUB_OUTPUT
            echo "Using PAT token for fork testing"
          else
            echo "token=${{ github.token }}" >> $GITHUB_OUTPUT
            echo "mode=default" >> $GITHUB_OUTPUT
            echo "Using default GITHUB_TOKEN"
          fi
      - name: Checkout opentelemetry-configuration
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          path: opentelemetry-configuration

      - name: Determine target repository
        id: target_repo
        run: |
          # Determine which opentelemetry.io repo to use
          TARGET_OWNER="${{ inputs.target_repo_owner }}"
          FORK_OWNER="${{ secrets.DOCS_REPO_OWNER || github.repository_owner }}"

          # Check if targeting a fork (not open-telemetry)
          if [ "$TARGET_OWNER" != "open-telemetry" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "repo_owner=$FORK_OWNER" >> $GITHUB_OUTPUT
            echo "Using fork: $FORK_OWNER/opentelemetry.io"
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
            echo "repo_owner=open-telemetry" >> $GITHUB_OUTPUT
            echo "Using upstream: open-telemetry/opentelemetry.io"
          fi

      - name: Checkout opentelemetry.io
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ steps.target_repo.outputs.repo_owner }}/opentelemetry.io
          path: opentelemetry.io
          ref: ${{ inputs.target_branch }}
          token: ${{ steps.auth.outputs.token }}
          persist-credentials: false

      - name: Sync fork with upstream
        if: steps.target_repo.outputs.is_fork == 'true'
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
          FORK_OWNER: ${{ secrets.DOCS_REPO_OWNER || github.repository_owner }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          cd opentelemetry.io

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add upstream remote
          git remote add upstream https://github.com/open-telemetry/opentelemetry.io.git || true

          # Fetch upstream changes
          git fetch upstream

          # Sync target branch with upstream
          git checkout ${TARGET_BRANCH}

          # Try to merge from upstream branch (if it exists), otherwise just use local branch
          if git ls-remote --heads upstream ${TARGET_BRANCH} | grep -q ${TARGET_BRANCH}; then
            git merge upstream/${TARGET_BRANCH} --no-edit || echo "Already up to date"
          else
            echo "Branch ${TARGET_BRANCH} does not exist in upstream, using local branch only"
          fi

          # Add authenticated origin remote for pushing
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${FORK_OWNER}/opentelemetry.io.git

          # Push synced changes back to fork
          git push origin ${TARGET_BRANCH} || echo "Nothing to push"
        continue-on-error: false

      - name: Set up Node.js for opentelemetry-configuration
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 'lts/*'

      - name: Install Node.js dependencies for opentelemetry-configuration
        run: npm install
        working-directory: opentelemetry-configuration

      - name: Generate documentation
        run: |
          if [ -n "${{ inputs.page_param }}" ]; then
            make synchronize-documentation DOCS_REPO=../opentelemetry.io PAGE=${{ inputs.page_param }}
          else
            make synchronize-documentation DOCS_REPO=../opentelemetry.io
          fi
        working-directory: opentelemetry-configuration

      - name: Set up Node.js for opentelemetry.io
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: opentelemetry.io/.nvmrc

      - name: Install Node.js dependencies for opentelemetry.io
        run: npm install --omit=optional
        working-directory: opentelemetry.io

      - name: Format and fix documentation
        run: npm run test-and-fix
        working-directory: opentelemetry.io
        continue-on-error: true

      - name: Check for documentation changes
        id: check_changes
        run: |
          cd opentelemetry.io
          if git diff --quiet content/en/docs/languages/sdk-configuration/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No documentation changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Documentation changes detected:"
            git --no-pager diff --name-only content/en/docs/languages/sdk-configuration/
          fi

      - name: Get version info
        if: steps.check_changes.outputs.has_changes == 'true'
        id: version_info
        run: |
          cd opentelemetry-configuration
          TIMESTAMP=$(date +%Y%m%d)
          BRANCH_NAME="${{ inputs.branch_prefix }}-${TIMESTAMP}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Configure git identity
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          cd opentelemetry.io
          # Use otelbot identity in upstream mode, github-actions bot otherwise
          if [ "${{ steps.auth.outputs.mode }}" = "upstream" ]; then
            git config user.name "otelbot"
            git config user.email "197425009+otelbot@users.noreply.github.com"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
          fi

      - name: Create branch and commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          cd opentelemetry.io

          # Ensure we're on the target branch
          git checkout ${TARGET_BRANCH}

          # Create or reset branch from current target branch (which is synced with upstream)
          git checkout -B ${{ steps.version_info.outputs.branch_name }}

          # Add and commit only the documentation changes
          git add content/en/docs/languages/sdk-configuration/*.md
          git commit -m "${{ inputs.commit_title }}

          Generated by opentelemetry-configuration repository." || echo "No changes to commit"

      - name: Push changes and create PR
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
          AUTH_MODE: ${{ steps.auth.outputs.mode }}
          FORK_OWNER: ${{ secrets.DOCS_REPO_OWNER || github.repository_owner }}
          TARGET_OWNER: ${{ inputs.target_repo_owner }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          cd opentelemetry.io

          # Clear any existing git credentials
          git config --unset-all http.https://github.com/.extraheader || true

          # Verify token is set
          if [ -z "${GH_TOKEN}" ]; then
            echo "ERROR: No authentication token available."
            exit 1
          fi

          BRANCH="${{ steps.version_info.outputs.branch_name }}"

          if [ "${AUTH_MODE}" = "upstream" ]; then
            git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${TARGET_OWNER}/opentelemetry.io.git
            git push -f origin "$BRANCH"
            PR_HEAD="$BRANCH"
          else
            git remote remove fork 2>/dev/null || true
            git remote add fork https://x-access-token:${GH_TOKEN}@github.com/${FORK_OWNER}/opentelemetry.io.git
            git push -f fork "$BRANCH"

            # Determine PR head format (cross-owner PRs need "owner:branch" format)
            if [ "${TARGET_OWNER}" = "${FORK_OWNER}" ]; then
              PR_HEAD="$BRANCH"
            else
              PR_HEAD="${FORK_OWNER}:${BRANCH}"
            fi
          fi

          # Build PR body
          PR_BODY="${{ inputs.pr_body_header }}

          ### Changes

          - ${{ inputs.pr_body_changes }}

          ---

          ðŸ¤– _This PR was automatically generated by [opentelemetry-configuration](https://github.com/open-telemetry/opentelemetry-configuration)_

          **Target:** ${TARGET_OWNER}/opentelemetry.io (branch: ${TARGET_BRANCH})"

          # Create PR (or update if already exists by pushing to same branch)
          gh pr create \
            --repo "${TARGET_OWNER}/opentelemetry.io" \
            --base "${TARGET_BRANCH}" \
            --head "${PR_HEAD}" \
            --title "${{ inputs.pr_title }}" \
            --body "$PR_BODY" \
            || echo "PR may already exist"